<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Claude Usage Dashboard</title>
		<style>
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}

			body {
				font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
				background: #0a0a0a;
				color: #e0e0e0;
				line-height: 1.6;
			}

			.container {
				max-width: 1400px;
				margin: 0 auto;
				padding: 20px;
			}

			header {
				text-align: center;
				margin-bottom: 40px;
				padding: 30px 0;
				background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
				border-radius: 12px;
				box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
			}

			h1 {
				font-size: 2.5em;
				font-weight: 300;
				margin-bottom: 10px;
				background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
				-webkit-background-clip: text;
				-webkit-text-fill-color: transparent;
			}

			.subtitle {
				color: #888;
				font-size: 1.1em;
			}

			.stats-grid {
				display: grid;
				grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
				gap: 20px;
				margin-bottom: 40px;
			}

			.stat-card {
				background: #1a1a2e;
				padding: 24px;
				border-radius: 12px;
				border: 1px solid #2a2a3e;
				transition:
					transform 0.2s,
					box-shadow 0.2s;
			}

			.stat-card:hover {
				transform: translateY(-2px);
				box-shadow: 0 8px 30px rgba(102, 126, 234, 0.1);
			}

			.stat-label {
				color: #888;
				font-size: 0.9em;
				text-transform: uppercase;
				letter-spacing: 1px;
				margin-bottom: 8px;
			}

			.stat-value {
				font-size: 2em;
				font-weight: 600;
				color: #fff;
				margin-bottom: 4px;
			}

			.stat-value.cost {
				color: #4ade80;
			}

			.stat-subtitle {
				color: #666;
				font-size: 0.85em;
			}

			.chart-container {
				background: #1a1a2e;
				padding: 24px;
				border-radius: 12px;
				border: 1px solid #2a2a3e;
				margin-bottom: 30px;
			}

			.chart-title {
				font-size: 1.3em;
				margin-bottom: 20px;
				color: #e0e0e0;
			}

			.hosts-projects {
				display: grid;
				grid-template-columns: 1fr 2fr;
				gap: 20px;
				margin-bottom: 30px;
			}

			.list-container {
				background: #1a1a2e;
				padding: 24px;
				border-radius: 12px;
				border: 1px solid #2a2a3e;
			}

			.list-title {
				font-size: 1.2em;
				margin-bottom: 16px;
				color: #e0e0e0;
				display: flex;
				align-items: center;
				gap: 10px;
			}

			.badge {
				background: #667eea;
				color: white;
				padding: 2px 8px;
				border-radius: 12px;
				font-size: 0.8em;
			}

			.list-item {
				padding: 12px;
				margin-bottom: 8px;
				background: #0f0f1e;
				border-radius: 8px;
				border: 1px solid #2a2a3e;
				display: flex;
				justify-content: space-between;
				align-items: center;
			}

			.list-item-name {
				font-weight: 500;
			}

			.list-item-stats {
				display: flex;
				gap: 20px;
				font-size: 0.9em;
				color: #888;
			}

			.token-type {
				display: flex;
				align-items: center;
				gap: 5px;
			}

			.dot {
				width: 8px;
				height: 8px;
				border-radius: 50%;
				display: inline-block;
			}

			.dot.input {
				background: #667eea;
			}
			.dot.output {
				background: #764ba2;
			}
			.dot.cache-create {
				background: #f093fb;
			}
			.dot.cache-read {
				background: #4facfe;
			}

			.daily-chart {
				height: 300px;
				position: relative;
				margin-top: 20px;
			}

			.chart-bar {
				display: flex;
				align-items: flex-end;
				height: 100%;
				gap: 4px;
				padding: 0 10px;
			}

			.bar {
				flex: 1;
				background: linear-gradient(to top, #667eea, #764ba2);
				border-radius: 4px 4px 0 0;
				position: relative;
				min-height: 5px;
				transition: opacity 0.2s;
				cursor: pointer;
			}

			.bar:hover {
				opacity: 0.8;
			}

			.bar-label {
				position: absolute;
				bottom: -25px;
				left: 50%;
				transform: translateX(-50%);
				font-size: 0.8em;
				color: #666;
				white-space: nowrap;
			}

			.loading {
				text-align: center;
				padding: 40px;
				color: #666;
			}

			.error {
				background: #991b1b;
				color: #fca5a5;
				padding: 16px;
				border-radius: 8px;
				margin-bottom: 20px;
			}

			.last-updated {
				text-align: center;
				color: #666;
				font-size: 0.9em;
				margin-top: 30px;
			}

			@media (max-width: 768px) {
				.hosts-projects {
					grid-template-columns: 1fr;
				}

				.stats-grid {
					grid-template-columns: 1fr;
				}
			}
		</style>
	</head>
	<body>
		<div class="container">
			<header>
				<h1>Claude Usage Dashboard</h1>
				<div class="subtitle">Real-time token usage and cost tracking</div>
			</header>

			<div id="loading" class="loading">Loading dashboard data...</div>
			<div id="error" class="error" style="display: none"></div>

			<div id="dashboard" style="display: none">
				<div class="stats-grid">
					<div class="stat-card">
						<div class="stat-label">Total Tokens Today</div>
						<div class="stat-value" id="totalTokens">0</div>
						<div class="stat-subtitle" id="tokenBreakdown">Loading...</div>
					</div>

					<div class="stat-card">
						<div class="stat-label">Total Cost Today</div>
						<div class="stat-value cost" id="totalCost">$0.00</div>
						<div class="stat-subtitle">USD</div>
					</div>

					<div class="stat-card">
						<div class="stat-label">Active Hosts</div>
						<div class="stat-value" id="hostCount">0</div>
						<div class="stat-subtitle">machines reporting</div>
					</div>

					<div class="stat-card">
						<div class="stat-label">Active Projects</div>
						<div class="stat-value" id="projectCount">0</div>
						<div class="stat-subtitle">unique projects</div>
					</div>
				</div>

				<div class="chart-container">
					<h2 class="chart-title">Token Usage - Last 7 Days</h2>
					<div class="daily-chart">
						<div class="chart-bar" id="dailyChart"></div>
					</div>
				</div>

				<div class="hosts-projects">
					<div class="list-container">
						<h3 class="list-title">
							Active Hosts
							<span class="badge" id="hostBadge">0</span>
						</h3>
						<div id="hostsList"></div>
					</div>

					<div class="list-container">
						<h3 class="list-title">
							Projects
							<span class="badge" id="projectBadge">0</span>
						</h3>
						<div id="projectsList"></div>
					</div>
				</div>

				<div class="last-updated" id="lastUpdated">Last updated: Never</div>
			</div>
		</div>

		<script>
			const guid = window.location.pathname.substring(1);
			const apiBase = window.location.origin;

			function formatNumber(num) {
				if (num >= 1e9) return (num / 1e9).toFixed(2) + 'B';
				if (num >= 1e6) return (num / 1e6).toFixed(2) + 'M';
				if (num >= 1e3) return (num / 1e3).toFixed(2) + 'K';
				return num.toLocaleString();
			}

			function formatCost(cost) {
				return '$' + cost.toFixed(2);
			}

			async function fetchDashboardData() {
				try {
					// Fetch current status
					const statusResponse = await fetch(`${apiBase}/v2/status/${guid}`);
					if (!statusResponse.ok) {
						throw new Error('Failed to fetch status data');
					}
					const statusData = await statusResponse.json();

					// Fetch daily data for the last 7 days
					const today = new Date();
					const sevenDaysAgo = new Date(today);
					sevenDaysAgo.setDate(today.getDate() - 6);

					const dailyResponse = await fetch(
						`${apiBase}/v2/daily/${guid}?since=${sevenDaysAgo.toISOString()}&until=${today.toISOString()}`,
					);
					if (!dailyResponse.ok) {
						throw new Error('Failed to fetch daily data');
					}
					const dailyData = await dailyResponse.json();

					return { status: statusData, daily: dailyData };
				} catch (error) {
					console.error('Error fetching data:', error);
					throw error;
				}
			}

			function updateDashboard(data) {
				const { status, daily } = data;

				// Calculate today's totals
				const today = new Date().toISOString().split('T')[0];
				const todayData = daily.daily.find((d) => d.date === today) || {
					totalTokens: 0,
					cost: 0,
					inputTokens: 0,
					outputTokens: 0,
					cacheCreationTokens: 0,
					cacheReadTokens: 0,
				};

				// Update stats cards
				document.getElementById('totalTokens').textContent = formatNumber(todayData.totalTokens);
				document.getElementById('totalCost').textContent = formatCost(todayData.cost);

				// Token breakdown
				const breakdown = `Input: ${formatNumber(todayData.inputTokens)} | Output: ${formatNumber(todayData.outputTokens)} | Cache: ${formatNumber(todayData.cacheCreationTokens + todayData.cacheReadTokens)}`;
				document.getElementById('tokenBreakdown').textContent = breakdown;

				// Host and project counts
				const uniqueHosts = new Set();
				const uniqueProjects = new Set();
				const projectTokens = {};

				status.entries.forEach((entry) => {
					uniqueHosts.add(entry.hostname);
					entry.projects.forEach((project) => {
						uniqueProjects.add(project.projectName);
						if (!projectTokens[project.projectName]) {
							projectTokens[project.projectName] = {
								tokens: { inputTokens: 0, outputTokens: 0, cacheCreationTokens: 0, cacheReadTokens: 0 },
								hosts: new Set(),
							};
						}
						projectTokens[project.projectName].tokens.inputTokens += project.tokens.inputTokens;
						projectTokens[project.projectName].tokens.outputTokens += project.tokens.outputTokens;
						projectTokens[project.projectName].tokens.cacheCreationTokens += project.tokens.cacheCreationTokens;
						projectTokens[project.projectName].tokens.cacheReadTokens += project.tokens.cacheReadTokens;
						projectTokens[project.projectName].hosts.add(entry.hostname);
					});
				});

				document.getElementById('hostCount').textContent = uniqueHosts.size;
				document.getElementById('projectCount').textContent = uniqueProjects.size;
				document.getElementById('hostBadge').textContent = uniqueHosts.size;
				document.getElementById('projectBadge').textContent = uniqueProjects.size;

				// Update hosts list
				const hostsList = document.getElementById('hostsList');
				hostsList.innerHTML = '';
				uniqueHosts.forEach((hostname) => {
					const hostProjects = status.entries.filter((e) => e.hostname === hostname).flatMap((e) => e.projects);
					const totalTokens = hostProjects.reduce(
						(sum, p) =>
							sum +
							p.tokens.inputTokens +
							p.tokens.outputTokens +
							p.tokens.cacheCreationTokens +
							p.tokens.cacheReadTokens,
						0,
					);

					const hostItem = document.createElement('div');
					hostItem.className = 'list-item';
					hostItem.innerHTML = `
                    <div class="list-item-name">${hostname}</div>
                    <div class="list-item-stats">
                        <span>${hostProjects.length} projects</span>
                        <span>${formatNumber(totalTokens)} tokens</span>
                    </div>
                `;
					hostsList.appendChild(hostItem);
				});

				// Update projects list
				const projectsList = document.getElementById('projectsList');
				projectsList.innerHTML = '';
				Object.entries(projectTokens)
					.sort((a, b) => {
						const totalA =
							a[1].tokens.inputTokens +
							a[1].tokens.outputTokens +
							a[1].tokens.cacheCreationTokens +
							a[1].tokens.cacheReadTokens;
						const totalB =
							b[1].tokens.inputTokens +
							b[1].tokens.outputTokens +
							b[1].tokens.cacheCreationTokens +
							b[1].tokens.cacheReadTokens;
						return totalB - totalA;
					})
					.forEach(([projectName, data]) => {
						const projectItem = document.createElement('div');
						projectItem.className = 'list-item';
						projectItem.innerHTML = `
                        <div class="list-item-name">${projectName}</div>
                        <div class="list-item-stats">
                            <div class="token-type"><span class="dot input"></span> ${formatNumber(data.tokens.inputTokens)}</div>
                            <div class="token-type"><span class="dot output"></span> ${formatNumber(data.tokens.outputTokens)}</div>
                            <div class="token-type"><span class="dot cache-create"></span> ${formatNumber(data.tokens.cacheCreationTokens)}</div>
                            <div class="token-type"><span class="dot cache-read"></span> ${formatNumber(data.tokens.cacheReadTokens)}</div>
                        </div>
                    `;
						projectsList.appendChild(projectItem);
					});

				// Update daily chart
				const chartBar = document.getElementById('dailyChart');
				chartBar.innerHTML = '';

				const maxTokens = Math.max(...daily.daily.map((d) => d.totalTokens));
				daily.daily.forEach((day) => {
					const bar = document.createElement('div');
					bar.className = 'bar';
					const height = (day.totalTokens / maxTokens) * 100;
					bar.style.height = `${height}%`;
					bar.title = `${day.date}: ${formatNumber(day.totalTokens)} tokens, ${formatCost(day.cost)}`;

					const label = document.createElement('div');
					label.className = 'bar-label';
					label.textContent = new Date(day.date).toLocaleDateString('en-US', { weekday: 'short' });
					bar.appendChild(label);

					chartBar.appendChild(bar);
				});

				// Update last updated time
				document.getElementById('lastUpdated').textContent = `Last updated: ${new Date().toLocaleTimeString()}`;

				// Show dashboard, hide loading
				document.getElementById('loading').style.display = 'none';
				document.getElementById('dashboard').style.display = 'block';
			}

			function showError(message) {
				document.getElementById('loading').style.display = 'none';
				document.getElementById('error').style.display = 'block';
				document.getElementById('error').textContent = `Error: ${message}`;
			}

			// Initial load
			fetchDashboardData()
				.then(updateDashboard)
				.catch((error) => showError(error.message));

			// Refresh every 30 seconds
			setInterval(() => {
				fetchDashboardData()
					.then(updateDashboard)
					.catch((error) => console.error('Refresh error:', error));
			}, 30000);
		</script>
	</body>
</html>
